# Starts a fork of mainnet, deploys the latest release, and runs L1 integration tests
{{> job-header-node.yml}}
steps:
  - checkout
  - attach_workspace:
      at: .
  - run:
      command: npm run fork:mainnet
      background: true
  - run:
      command: PROVIDER_URL=http://mainnet.optimism.io npm run fork:ovm
      background: true
  - cmd-wait-for-port:
      port: 8545
  - cmd-wait-for-port:
      port: 9991
  #- run:
  #    name: Run integration tests on l1
  #    command: |
  #      # Only compile and deploy when there are new contracts
  #      NEW_CONTRACTS=$(node bin.js sips --layer=base --unreleased --with-sources)
  #      if [ -z "$NEW_CONTRACTS" ]; then
  #        npx hardhat test:integration:l1 --use-fork
  #      else
  #        npx hardhat test:integration:l1 --compile --deploy --use-sips --use-fork
  #      fi;
  - run:
      name: Run integration tests on l2
      command: |
        # Only compile and deploy when there are new contracts
        NEW_CONTRACTS=$(node bin.js sips --layer=base --unreleased --with-sources)
        if [ -z "$NEW_CONTRACTS" ]; then
          npx hardhat test:integration:l2 --use-fork
        else
          npx hardhat test:integration:l2 --compile --deploy --use-sips --use-fork
        fi;
